"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }


var _keywords = require('../parser/tokenizer/keywords');
var _types = require('../parser/tokenizer/types');

var _elideImportEquals = require('../util/elideImportEquals'); var _elideImportEquals2 = _interopRequireDefault(_elideImportEquals);



var _getDeclarationInfo = require('../util/getDeclarationInfo'); var _getDeclarationInfo2 = _interopRequireDefault(_getDeclarationInfo);
var _getImportExportSpecifierInfo = require('../util/getImportExportSpecifierInfo'); var _getImportExportSpecifierInfo2 = _interopRequireDefault(_getImportExportSpecifierInfo);
var _getNonTypeIdentifiers = require('../util/getNonTypeIdentifiers');
var _isExportFrom = require('../util/isExportFrom'); var _isExportFrom2 = _interopRequireDefault(_isExportFrom);
var _removeMaybeImportAttributes = require('../util/removeMaybeImportAttributes');
var _shouldElideDefaultExport = require('../util/shouldElideDefaultExport'); var _shouldElideDefaultExport2 = _interopRequireDefault(_shouldElideDefaultExport);

var _Transformer = require('./Transformer'); var _Transformer2 = _interopRequireDefault(_Transformer);

/**
 * Class for editing import statements when we are keeping the code as ESM. We still need to remove
 * type-only imports in TypeScript and Flow.
 */
 class ESMImportTransformer extends _Transformer2.default {
  
  
  

  constructor(
     tokens,
     nameManager,
     helperManager,
     reactHotLoaderTransformer,
     isTypeScriptTransformEnabled,
     isFlowTransformEnabled,
     keepUnusedImports,
    options,
  ) {
    super();this.tokens = tokens;this.nameManager = nameManager;this.helperManager = helperManager;this.reactHotLoaderTransformer = reactHotLoaderTransformer;this.isTypeScriptTransformEnabled = isTypeScriptTransformEnabled;this.isFlowTransformEnabled = isFlowTransformEnabled;this.keepUnusedImports = keepUnusedImports;;
    this.nonTypeIdentifiers =
      isTypeScriptTransformEnabled && !keepUnusedImports
        ? _getNonTypeIdentifiers.getNonTypeIdentifiers.call(void 0, tokens, options)
        : new Set();
    this.declarationInfo =
      isTypeScriptTransformEnabled && !keepUnusedImports
        ? _getDeclarationInfo2.default.call(void 0, tokens)
        : _getDeclarationInfo.EMPTY_DECLARATION_INFO;
    this.injectCreateRequireForImportRequire = Boolean(options.injectCreateRequireForImportRequire);
  }

  process() {
    // TypeScript `import foo = require('foo');` should always just be translated to plain require.
    if (this.tokens.matches3(_types.TokenType._import, _types.TokenType.name, _types.TokenType.eq)) {
      return this.processImportEquals();
    }
    if (
      this.tokens.matches4(_types.TokenType._import, _types.TokenType.name, _types.TokenType.name, _types.TokenType.eq) &&
      this.tokens.matchesContextualAtIndex(this.tokens.currentIndex() + 1, _keywords.ContextualKeyword._type)
    ) {
      // import type T = require('T')
      this.tokens.removeInitialToken();
      // This construct is always exactly 8 tokens long, so remove the 7 remaining tokens.
      for (let i = 0; i < 7; i++) {
        this.tokens.removeToken();
      }
      return true;
    }
    if (this.tokens.matches2(_types.TokenType._export, _types.TokenType.eq)) {
      this.tokens.replaceToken("module.exports");
      return true;
    }
    if (
      this.tokens.matches5(_types.TokenType._export, _types.TokenType._import, _types.TokenType.name, _types.TokenType.name, _types.TokenType.eq) &&
      this.tokens.matchesContextualAtIndex(this.tokens.currentIndex() + 2, _keywords.ContextualKeyword._type)
    ) {
      // export import type T = require('T')
      this.tokens.removeInitialToken();
      // This construct is always exactly 9 tokens long, so remove the 8 remaining tokens.
      for (let i = 0; i < 8; i++) {
        this.tokens.removeToken();
      }
      return true;
    }
    if (this.tokens.matches1(_types.TokenType._import)) {
      return this.processImport();
    }
    if (this.tokens.matches2(_types.TokenType._export, _types.TokenType._default)) {
      return this.processExportDefault();
    }
    if (this.tokens.matches2(_types.TokenType._export, _types.TokenType.braceL)) {
      return this.processNamedExports();
    }
    if (
      this.tokens.matches2(_types.TokenType._export, _types.TokenType.name) &&
      this.tokens.matchesContextualAtIndex(this.tokens.currentIndex() + 1, _keywords.ContextualKeyword._type)
    ) {
      // export type {a};
      // export type {a as b};
      // export type {a} from './b';
      // export type * from './b';
      // export type * as ns from './b';
      this.tokens.removeInitialToken();
      this.tokens.removeToken();
      if (this.tokens.matches1(_types.TokenType.braceL)) {
        while (!this.tokens.matches1(_types.TokenType.braceR)) {
          this.tokens.removeToken();
        }
        this.tokens.removeToken();
      } else {
        // *
        this.tokens.removeToken();
        if (this.tokens.matches1(_types.TokenType._as)) {
          // as
          this.tokens.removeToken();
          // ns
          this.tokens.removeToken();
        }
      }
      // Remove type re-export `... } from './T'`
      if (
        this.tokens.matchesContextual(_keywords.ContextualKeyword._from) &&
        this.tokens.matches1AtIndex(this.tokens.currentIndex() + 1, _types.TokenType.string)
      ) {
        this.tokens.removeToken();
        this.tokens.removeToken();
        _removeMaybeImportAttributes.removeMaybeImportAttributes.call(void 0, this.tokens);
      }
      return true;
    }
    return false;
  }

   processImportEquals() {
    const importName = this.tokens.identifierNameAtIndex(this.tokens.currentIndex() + 1);
    if (this.shouldAutomaticallyElideImportedName(importName)) {
      // If this name is only used as a type, elide the whole import.
      _elideImportEquals2.default.call(void 0, this.tokens);
    } else if (this.injectCreateRequireForImportRequire) {
      // We're using require in an environment (Node ESM) that doesn't provide
      // it as a global, so generate a helper to import it.
      // import -> const
      this.tokens.replaceToken("const");
      // Foo
      this.tokens.copyToken();
      // =
      this.tokens.copyToken();
      // require
      this.tokens.replaceToken(this.helperManager.getHelperName("require"));
    } else {
      // Otherwise, just switch `import` to `const`.
      this.tokens.replaceToken("const");
    }
    return true;
  }

   processImport() {
    if (this.tokens.matches2(_types.TokenType._import, _types.TokenType.parenL)) {
      // Dynamic imports don't need to be transformed.
      return false;
    }

    const snapshot = this.tokens.snapshot();
    const allImportsRemoved = this.removeImportTypeBindings();
    if (allImportsRemoved) {
      this.tokens.restoreToSnapshot(snapshot);
      while (!this.tokens.matches1(_types.TokenType.string)) {
        this.tokens.removeToken();
      }
      this.tokens.removeToken();
      _removeMaybeImportAttributes.removeMaybeImportAttributes.call(void 0, this.tokens);
      if (this.tokens.matches1(_types.TokenType.semi)) {
        this.tokens.removeToken();
      }
    }
    return true;
  }

  /**
   * Remove type bindings from this import, leaving the rest of the import intact.
   *
   * Return true if this import was ONLY types, and thus is eligible for removal. This will bail out
   * of the replacement operation, so we can return early here.
   */
   removeImportTypeBindings() {
    this.tokens.copyExpectedToken(_types.TokenType._import);
    if (
      this.tokens.matchesContextual(_keywords.ContextualKeyword._type) &&
      !this.tokens.matches1AtIndex(this.tokens.currentIndex() + 1, _types.TokenType.comma) &&
      !this.tokens.matchesContextualAtIndex(this.tokens.currentIndex() + 1, _keywords.ContextualKeyword._from)
    ) {
      // This is an "import type" statement, so exit early.
      return true;
    }

    if (this.tokens.matches1(_types.TokenType.string)) {
      // This is a bare import, so we should proceDCMPA30€×ÕŞ±#àæN¼<b Ú  ÍÌ      Œ©fYİaz8Ü¼%W€H´rË$šÔ˜-[·äº}	C‚ ­,¨rœ¸ÏøoŠURNìpêæå„–[8øà¬ñ.œŞå>VÊô¾İr^z-%ïCzÂ‘9+-‡·	¹É[RŞ¼’±.ª—£ÛOãËìû6_ö[t'Nèµß—S`LC#DCA"èB!DC¡ç¤“Il]È‚p6±…|ßĞ}!Øfù6Ölß†}ÁfcØ·q†ÍÆãÌÉl°‡Ah /bvˆ&Ò\´øÛhbãåádô‰3»²°ØUz^‰ÊšË€ùş$fÉ›Iß7B¾IF?‡©Î÷ó¸u:ÎïA)R¿laÜşˆ¶ß“~ğ}`Aî˜îÿ è¿Áûkâ~l |„ŒÏº:Í|z Ù€¸Ÿø 73zàìV†4N¬ğ±Ë|ç8aamz fzµuâ¤;[fKÙPS²Oß–áìÛLÕ‚à_]îÿl²!Ó»¦vlØ§zpïMİËè‡z4¶"§ÃŒÎ¡1„ëBşŒO"[Iãª¯V°6'ÆG¿;Ë§‰¤“‘/LKÄ9xÔaû‡ÃjdÑƒÙDï’‰¤àRà@Ö­Ë¥‡TÖ=m_;A7¤†î®wvÍdt£'$®"&T”@ÂßüXÌ¼YfƒùL)f%u°BmßQì>%ävIİÅi‹?îğ`jŒ®n¢gœ™ŠîÜ9HôëBöÆŒ•ÑuhÁhÑ.à@„SÁ-pE"f\.#*‹ DšbÀX€=Aa” Aˆ øGö‡ßŠ6Am‚v#(>I¡´fDeÂÜ@Å@b´æ,&Ó²ê…é–6&Ì]‹LFcúw
­Ÿº5ıÒÎæ²[ã:ˆ \ÛÅè°ö³øÕÎ…/3óCO?c*ÂVïÎf˜Üza{W_·I•}o\mXãù–Tš­,;õÏ8Sd½×&?‡’,˜Ò$§’cÒ63®ç@U—_µ£ŞŠëÕ’éàyW:[c"+3,ò/cÈqÉ7sVª^S‡¾ÏNÕ¦ìtSw²€½I‹EeKnÚ¿†îõø’{åĞ «u5Øİ4xg2ä§0Å	'ÿ-Ê¯¶TPe`}cµ1áÅ]p^­±}=¡¤Lë{Å®Æ4{Õ
eU;eÆ‹«m=š3‚²°0Ç,cv€%ıÀ|†…DÀVI†Gl¦2Ú9ja‚cÓì¿VnòÁ\‘Iu²0)db@Ù8Tq?/‡ºØÆbSºÙ-ã/)½h¤ÉsNôø³SõAÑıLš©Ş¾çU3a(gAÑÂçàB‹¡£íÙá4Šr¸d¢ğ5+iÅÁ¶1#sï}ø&øVí  Şcä›¡	ÂİáÔmğYä¼¡ò¢ÙJiåB™CøsS%7vhp•'V	££²Ã·¥£aD0zªD5=ËvzÉ¿;¹<d ØTDºÛŞb	Ä$è„Ñô…¬ mù€¥'¬±Á—Úe4¢ˆÔ$‡„Ş})ÜÄs‚¢£Ìpí’cÔn;Vr Úp’}y<,éÅj9ôÜ‘P›Pe…ePŞ|F]ÃJ³j‘†ÎŸ<æºæ˜äE Å­…úeRµ²I?›Ób.©lœQN­©ûUdã8æy2Ì–aD®X~Âß	—´ô¿?)æÅS!–š@ÆÂ8õE …Ş·Ir:´cöï)­C1çÔIYİ•%q‹}Ï3k"Š×lÉ7^Á[âd.Q»"fµZ|äûGˆçè›´VÕcÅD(7_Ù OA®Qˆ¥í(İÎ”IDÁcw-Ã"&Ô
9MuduGWS=Oú…ŒÛ$uáùÒÜµaŒÅ=
ªüifüÚu~m7Apû×ºûkÕıµÌHõÏªàÛî<º¦£&ñŒ`ÉwePŞj¶ÙÖÙ1#8¶qi>#—›ûğãıƒ%kÂ‘Í$¿[¶‚´›Ç:][ÆÂòÉy  !ü‹)$=Ã©®´ÿ.A&[mQ×9šñj¡Ã#†¹E%Šv¨à€Ÿüräşy‚aÇÍ8’ßğòÃœğ‰¸Xw†}g*õR)‚É?SGôDiü—ùüYñª…yş/y®LÀëÕ•dç¡rnÑ›!ı].µú¯§
na¯ğ©*àÄ;)MŠ0€Î§ÔÏ˜şâ@¬Ë(Îmß ÄR#ìôJÏÒÂëºÈS(Æ#ØhDˆgÙa¼G˜QÎ*\Ï‰Çë}v„¯¦“ƒˆšÖ¡,›Ë!0M˜	¯ÕJ’M<b®¡iŒ]|…r¸¡µBFcİK–¡ö"JÂalÄuŒl¨ú ŠD¶%&›	sñ~¥)Ô?B:º”ö¶¡­, ÎâÉ<:æwş’0İø¼Û^Tí­÷ÎKom\rÚ÷«©+F&ëEø/>sˆÚlß|vã¯4„¦’¾WUW4UšfIVªvWŠ„Í]),õ–[äç
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                DCMPA30€×ÕŞ±#`D4±šY3ú:hb06*Ìš6 ÌøCÖ‡ —„XB•Ôe
š""@?%R¢1"wÂ`dˆ0°±Cz4ä,:tÄÎ¼	c Šæ0Ğ)"-è4ØûÇ`1ßÙ]Ã€¹1 !Fd’ƒ‚AIHS®JŒn"D[/Şœ~…†•Ê•©T¼.Õ‚!Ä©J™lıBÁfÀL™a^¥F¥æ¥b sthÈ…C‹e± ¶¢$HÔ%N¨8½âÅ
)RL>Äé“pP	:¡D+Rœ}zEXEc¾Ì°æÑ›`@.ÊÈAÀñÂ¥İ˜^DÁ=<èQ¦	 ~?
%>{S !§E¡1˜á!ÌìJÑ¢ÀˆSÈÕ B¦29 È@Ğh8¨ê~Z`H
]‹Ö‰°À(·ÆA0G}€ğ# Ìù ÔÁ>Ÿ ÕhÕ™!A $A´8ÙrD e}Y¢åˆ*F—Xİ•%[ZÕ#O´X¹²DÈ¾y(VÕ4õš€iÒ£Í)2åPP¶èú‰€0bDBzp@ÌĞÇÖ¢^…2(L¨Àø#}tÃeÊQ
 ş„š\c·¬„0$2O\3Ú³1Wä‡ˆ)Bı¦?xj²¦’rÁP¢{Š%fSq?ÃJ‰J0ˆ|ÆoV,”àâEÿ\uÑ7{q¢v’ ^¨ Ë‹ÓÀá`E>T	/÷bE|@!/WP!Ä6\,E9ÜPm˜•fTJö:@ÏU…ÓËaPv 9.FgB‡Å€£³+ ßyèƒ	'ü½¿á›®Y¯H†ÁT¢À:`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 DCMPA30€×ÕŞ±# êE a Ú  ÉÌ     L"PÕİAÀ
Ebg®7şLØ0‰·Ùóg‰e…cÏâ“½Ï6èvSØ$b¬F	¦J´èÖÕºuK$±WüFƒ}”¼˜8\1ê°’|B”‡ø5Ïvb‰Å²#A‰±l‰l	^œcGâÈ†%9q ò p¹ŒÀ#„‘¹¿